name: Build macOS
on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  build-mac:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin,aarch64-apple-darwin

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install

      - name: Generate app icons
        run: |
          python3 << 'PYEOF'
          import struct, zlib
          def write_png(filename, width, height, r, g, b):
              def chunk(tag, data):
                  crc = zlib.crc32(tag + data) & 0xffffffff
                  return struct.pack('>I', len(data)) + tag + data + struct.pack('>I', crc)
              sig = b'\x89PNG\r\n\x1a\n'
              ihdr = chunk(b'IHDR', struct.pack('>IIBBBBB', width, height, 8, 2, 0, 0, 0))
              scanlines = b''.join(b'\x00' + bytes([r, g, b] * width) for _ in range(height))
              idat = chunk(b'IDAT', zlib.compress(scanlines))
              iend = chunk(b'IEND', b'')
              with open(filename, 'wb') as f:
                  f.write(sig + ihdr + idat + iend)
          write_png('/tmp/app-icon.png', 1024, 1024, 220, 38, 38)
          PYEOF
          npx tauri icon /tmp/app-icon.png

      - name: Build app
        run: npm run tauri:build -- --target universal-apple-darwin
        env:
          MACOSX_DEPLOYMENT_TARGET: "10.14"

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: heavy-metal-playlist-mac
          path: src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
          if-no-files-found: error
