<div class="songs-container">
  <!-- Header -->
  <div class="songs-header">
    <div class="songs-title-row">
      <h2 class="songs-title">
        <nb-icon icon="music-outline"></nb-icon>
        Librería de Canciones
      </h2>
      <span class="songs-count" *ngIf="songs.length > 0"
        >{{ songs.length }} canciones</span
      >
    </div>
    <div class="header-actions">
      <input
        nbInput
        type="text"
        [(ngModel)]="searchQuery"
        placeholder="Buscar por título, artista o género..."
        class="search-input"
      />
      <button
        nbButton
        status="primary"
        size="medium"
        (click)="openCreateForm()"
      >
        <nb-icon icon="plus-outline"></nb-icon>
        Nueva canción
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-container" *ngIf="loading">
    <nb-spinner size="giant" status="primary"></nb-spinner>
  </div>

  <!-- Empty state -->
  <nb-alert
    *ngIf="!loading && songs.length === 0"
    status="info"
    class="empty-state"
  >
    <nb-icon icon="music-outline" class="empty-icon"></nb-icon>
    <p>La librería está vacía.</p>
    <p>Añade canciones aquí para reutilizarlas en varias playlists.</p>
  </nb-alert>

  <!-- No results -->
  <nb-alert
    *ngIf="!loading && songs.length > 0 && filteredSongs.length === 0"
    status="warning"
    class="empty-state"
  >
    <nb-icon icon="search-outline" class="empty-icon"></nb-icon>
    <p>No se encontraron canciones para "{{ searchQuery }}"</p>
  </nb-alert>

  <!-- Songs table -->
  <div class="table-wrapper" *ngIf="!loading && filteredSongs.length > 0">
    <table class="songs-table">
      <thead>
        <tr>
          <th class="col-title">Título / Álbum</th>
          <th class="col-artist">Artista</th>
          <th class="col-genre">Género</th>
          <th class="col-tempo">BPM</th>
          <th class="col-duration">Duración</th>
          <th class="col-actions">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let song of filteredSongs" class="song-row">
          <!-- Título + Álbum -->
          <td class="col-title">
            <span class="song-title">{{ song.title }}</span>
            <span class="song-album" *ngIf="song.album">{{ song.album }}</span>
          </td>

          <!-- Artista -->
          <td class="col-artist">{{ song.artist }}</td>

          <!-- Género -->
          <td class="col-genre">
            <span
              *ngIf="song.style"
              class="genre-tag"
              [ngStyle]="getGenreStyle(song.style)"
            >
              {{ song.style }}
            </span>
            <span *ngIf="!song.style" class="empty-cell">—</span>
          </td>

          <!-- BPM -->
          <td class="col-tempo">
            <span *ngIf="song.tempo">{{ song.tempo }}</span>
            <span *ngIf="!song.tempo" class="empty-cell">—</span>
          </td>

          <!-- Duración -->
          <td class="col-duration">
            <span *ngIf="song.duration">{{
              formatDuration(song.duration)
            }}</span>
            <span *ngIf="!song.duration" class="empty-cell">—</span>
          </td>

          <!-- Acciones -->
          <td class="col-actions">
            <button
              nbButton
              ghost
              status="success"
              size="small"
              nbTooltip="Añadir a una playlist"
              (click)="openAddToPlaylist(song)"
            >
              <nb-icon icon="plus-circle-outline"></nb-icon>
            </button>
            <button
              nbButton
              ghost
              status="info"
              size="small"
              nbTooltip="Editar"
              (click)="openEditForm(song)"
            >
              <nb-icon icon="edit-outline"></nb-icon>
            </button>
            <button
              nbButton
              ghost
              status="danger"
              size="small"
              nbTooltip="Eliminar"
              (click)="deleteSong(song)"
            >
              <nb-icon icon="trash-2-outline"></nb-icon>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Add to playlist dialog -->
  <div class="add-to-playlist-overlay" [hidden]="!addingToPlaylist">
    <nb-card class="add-to-playlist-card">
      <nb-card-header>
        Añadir a playlist
        <span class="atp-song-name">{{ addingToPlaylist?.title }}</span>
      </nb-card-header>
      <nb-card-body>
        <div class="field-group">
          <label class="label">Playlist *</label>
          <div class="playlist-dropdown" [class.open]="dropdownOpen">
            <button
              type="button"
              class="dropdown-trigger"
              (click)="toggleDropdown(); $event.stopPropagation()"
            >
              <span [class.placeholder]="!selectedPlaylistId">
                {{
                  selectedPlaylistId
                    ? selectedPlaylistName
                    : "Selecciona una playlist"
                }}
              </span>
              <nb-icon icon="chevron-down-outline"></nb-icon>
            </button>
            <div
              class="dropdown-panel"
              *ngIf="dropdownOpen"
              [style.top.px]="panelTop"
              [style.left.px]="panelLeft"
              [style.width.px]="panelWidth"
            >
              <div
                class="dropdown-option"
                *ngFor="let p of playlists"
                [class.active]="p.id === selectedPlaylistId"
                (click)="selectPlaylist(p); $event.stopPropagation()"
              >
                {{ p.name }}
              </div>
            </div>
          </div>
        </div>
        <div class="field-group">
          <label class="label">Nombre en setlist</label>
          <input
            nbInput
            fullWidth
            [(ngModel)]="addSetlistName"
            placeholder="Dejar vacío para usar el título original"
          />
        </div>
        <div class="field-group">
          <nb-checkbox [(checked)]="addJoinWithNext"
            >Unir con la siguiente canción</nb-checkbox
          >
        </div>
      </nb-card-body>
      <nb-card-footer>
        <div class="actions">
          <button
            nbButton
            status="basic"
            type="button"
            (click)="cancelAddToPlaylist()"
          >
            Cancelar
          </button>
          <button
            nbButton
            status="primary"
            type="button"
            [disabled]="!selectedPlaylistId || addingInProgress"
            (click)="confirmAddToPlaylist()"
          >
            <nb-icon icon="plus-outline"></nb-icon>
            Añadir
          </button>
        </div>
      </nb-card-footer>
    </nb-card>
  </div>
</div>
