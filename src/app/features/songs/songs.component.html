<div class="songs-container">

  <!-- Header -->
  <div class="flex items-center justify-between mb-6 flex-wrap gap-3">
    <div>
      <h1 class="text-2xl font-bold">Librería de Canciones</h1>
      <p class="text-sm opacity-60">{{ songs.length }} canciones en la librería</p>
    </div>
    <div class="flex items-center gap-2">
      <input
        class="input input-bordered w-72"
        type="text"
        [(ngModel)]="searchQuery"
        placeholder="Buscar por título, artista o género..." />
      <button class="btn btn-primary gap-2" (click)="openCreateForm()">
        <ng-icon name="heroPlus" size="18"></ng-icon>
        Nueva canción
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-container" *ngIf="loading">
    <span class="loading loading-spinner loading-lg text-primary"></span>
  </div>

  <!-- Empty state -->
  <div *ngIf="!loading && songs.length === 0" class="empty-state">
    <ng-icon name="heroMusicalNote" class="w-8 h-8"></ng-icon>
    <div>
      <p>La librería está vacía.</p>
      <p>Añade canciones aquí para reutilizarlas en varias playlists.</p>
    </div>
  </div>

  <!-- No results -->
  <div *ngIf="!loading && songs.length > 0 && filteredSongs.length === 0" class="empty-state empty-state--search">
    <ng-icon name="heroMagnifyingGlass" class="w-8 h-8"></ng-icon>
    <p>No se encontraron canciones para "{{ searchQuery }}"</p>
  </div>

  <!-- Songs table -->
  <div class="table-wrapper" *ngIf="!loading && filteredSongs.length > 0">
    <table class="songs-table">
      <thead>
        <tr>
          <th class="col-title">Título / Álbum</th>
          <th class="col-artist">Artista</th>
          <th class="col-genre">Género</th>
          <th class="col-tempo">BPM</th>
          <th class="col-duration">Duración</th>
          <th class="col-actions">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let song of filteredSongs" class="song-row">
          <td class="col-title">
            <span class="song-title">{{ song.title }}</span>
            <span class="song-album" *ngIf="song.album">{{ song.album }}</span>
          </td>
          <td class="col-artist">{{ song.artist }}</td>
          <td class="col-genre">
            <span *ngIf="song.style" class="genre-tag" [ngStyle]="getGenreStyle(song.style)">
              {{ song.style }}
            </span>
            <span *ngIf="!song.style" class="empty-cell">—</span>
          </td>
          <td class="col-tempo">
            <span *ngIf="song.tempo">{{ song.tempo }}</span>
            <span *ngIf="!song.tempo" class="empty-cell">—</span>
          </td>
          <td class="col-duration">
            <span *ngIf="song.duration">{{ formatDuration(song.duration) }}</span>
            <span *ngIf="!song.duration" class="empty-cell">—</span>
          </td>
          <td class="col-actions">
            <button
              class="btn btn-ghost btn-xs tooltip"
              data-tip="Añadir a una playlist"
              (click)="openAddToPlaylist(song)">
              <ng-icon name="heroPlusCircle" class="w-4 h-4"></ng-icon>
            </button>
            <button
              class="btn btn-ghost btn-xs tooltip"
              data-tip="Editar"
              (click)="openEditForm(song)">
              <ng-icon name="heroPencil" class="w-4 h-4"></ng-icon>
            </button>
            <button
              class="btn btn-ghost btn-xs text-error tooltip"
              data-tip="Eliminar"
              (click)="deleteSong(song)">
              <ng-icon name="heroTrash" class="w-4 h-4"></ng-icon>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Add-to-playlist modal (DaisyUI inline modal) -->
  <div class="modal" [class.modal-open]="addingToPlaylist !== null">
    <div class="modal-box w-[420px] max-w-[95vw]">
      <h3 class="font-bold text-lg">Añadir a playlist</h3>
      <p class="text-sm opacity-60 mb-4">{{ addingToPlaylist?.title }}</p>

      <div class="field-group">
        <label class="field-label">Playlist <span class="text-error">*</span></label>
        <select class="select select-bordered w-full" [(ngModel)]="selectedPlaylistId">
          <option *ngFor="let p of playlists" [value]="p.id">{{ p.name }}</option>
        </select>
        <p *ngIf="playlists.length === 0" class="text-sm opacity-60 mt-1">
          No tienes playlists. Crea una primero.
        </p>
      </div>

      <div class="field-group">
        <label class="field-label">Nombre en setlist</label>
        <input
          class="input input-bordered w-full"
          [(ngModel)]="addSetlistName"
          placeholder="Dejar vacío para usar el título original" />
      </div>

      <div class="field-group">
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" class="checkbox checkbox-sm" [(ngModel)]="addJoinWithNext" />
          <span class="text-sm">Unir con la siguiente canción</span>
        </label>
      </div>

      <div class="modal-action">
        <button class="btn btn-ghost btn-sm" type="button" (click)="cancelAddToPlaylist()">
          Cancelar
        </button>
        <button
          class="btn btn-primary btn-sm"
          type="button"
          [disabled]="!selectedPlaylistId || addingInProgress"
          (click)="confirmAddToPlaylist()">
          <span *ngIf="addingInProgress" class="loading loading-spinner loading-xs"></span>
          <ng-icon *ngIf="!addingInProgress" name="heroPlus" class="w-4 h-4"></ng-icon>
          Añadir
        </button>
      </div>
    </div>
    <div class="modal-backdrop" (click)="cancelAddToPlaylist()"></div>
  </div>

</div>
