<div class="playlist-container">

  <!-- Header bar -->
  <div class="playlist-header">
    <div class="playlist-info">
      <div class="playlist-nav">
        <button class="btn btn-ghost btn-sm tooltip" data-tip="Volver a playlists" (click)="back.emit()">
          <ng-icon name="heroArrowLeft" class="w-4 h-4"></ng-icon>
          Playlists
        </button>
        <span class="breadcrumb-sep">/</span>
        <h2 class="playlist-title">
          <ng-icon name="heroMusicalNote" class="w-5 h-5"></ng-icon>
          {{ playlist.name }}
        </h2>
      </div>
      <span class="playlist-stats" *ngIf="songs.length > 0">
        {{ songs.length }} elementos
        <span *ngIf="totalDuration"> · {{ totalDuration }}</span>
      </span>
    </div>
    <div class="header-actions">
      <button
        class="btn btn-ghost btn-sm tooltip"
        data-tip="Exportar a PDF para imprimir"
        *ngIf="songs.length > 0"
        (click)="exportToPdf()">
        <ng-icon name="heroPrinter" class="w-4 h-4"></ng-icon>
        Exportar PDF
      </button>
      <button class="btn btn-ghost btn-sm" (click)="openAddEvent()">
        <ng-icon name="heroStar" class="w-4 h-4"></ng-icon>
        Añadir evento
      </button>
      <button class="btn btn-primary btn-sm" (click)="openAddForm()">
        <ng-icon name="heroPlus" class="w-4 h-4"></ng-icon>
        Nueva canción
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading-container" *ngIf="loading">
    <span class="loading loading-spinner loading-lg text-primary"></span>
  </div>

  <!-- Empty state -->
  <div *ngIf="!loading && songs.length === 0" class="alert alert-info empty-state">
    <ng-icon name="heroMusicalNote" class="w-8 h-8"></ng-icon>
    <div>
      <p>El setlist está vacío.</p>
      <p>Pulsa <strong>Nueva canción</strong> para empezar.</p>
    </div>
  </div>

  <!-- Song table con drag & drop -->
  <div class="table-wrapper" *ngIf="!loading && songs.length > 0">
    <table class="songs-table">
      <thead>
        <tr>
          <th class="col-drag"></th>
          <th class="col-pos">#</th>
          <th class="col-title">Título</th>
          <th class="col-setlist">En setlist</th>
          <th class="col-artist">Artista</th>
          <th class="col-genre">Género</th>
          <th class="col-tempo">BPM</th>
          <th class="col-duration">Duración</th>
          <th class="col-actions">Acciones</th>
        </tr>
      </thead>
      <tbody cdkDropList (cdkDropListDropped)="onDrop($event)">
        <tr
          *ngFor="let song of songs; let i = index"
          cdkDrag
          class="song-row"
          [class.event-row]="song.type === 'event'"
          [class.join-start]="isJoinStart(i)"
          [class.join-end]="isJoinEnd(i)">

          <!-- Drag handle -->
          <td class="col-drag">
            <div cdkDragHandle class="drag-handle tooltip" data-tip="Arrastra para reordenar">
              <ng-icon name="heroBars3" class="w-4 h-4"></ng-icon>
            </div>
          </td>

          <!-- Event row -->
          <ng-container *ngIf="song.type === 'event'">
            <td class="col-pos"></td>
            <td colspan="6" class="event-cell">---- {{ song.title }}</td>
            <td class="col-actions">
              <button class="btn btn-ghost btn-xs invisible" aria-hidden="true" tabindex="-1">
                <ng-icon name="heroArrowTurnDownRight" class="w-4 h-4"></ng-icon>
              </button>
              <button class="btn btn-ghost btn-xs tooltip" data-tip="Editar" (click)="openEditForm(song)">
                <ng-icon name="heroPencil" class="w-4 h-4"></ng-icon>
              </button>
              <button class="btn btn-ghost btn-xs text-error tooltip" data-tip="Eliminar" (click)="deleteSong(song)">
                <ng-icon name="heroTrash" class="w-4 h-4"></ng-icon>
              </button>
            </td>
          </ng-container>

          <!-- Song row -->
          <ng-container *ngIf="!song.type || song.type === 'song'">

            <td class="col-pos">
              <span class="position-badge">{{ songNumber(i) }}</span>
            </td>

            <td class="col-title">
              <span class="song-title">{{ song.title }}</span>
              <span class="song-album" *ngIf="song.album">{{ song.album }}</span>
            </td>

            <td class="col-setlist">
              <span *ngIf="song.setlistName" class="setlist-name">{{ song.setlistName }}</span>
              <span *ngIf="!song.setlistName" class="empty-cell">—</span>
            </td>

            <td class="col-artist">{{ song.artist }}</td>

            <td class="col-genre">
              <span
                *ngIf="song.style"
                class="genre-tag"
                [ngStyle]="getGenreStyle(song.style)">
                {{ song.style }}
              </span>
              <span *ngIf="!song.style" class="empty-cell">—</span>
            </td>

            <td class="col-tempo">
              <span *ngIf="song.tempo">{{ song.tempo }}</span>
              <span *ngIf="!song.tempo" class="empty-cell">—</span>
            </td>

            <td class="col-duration">
              <span class="duration-val" *ngIf="song.duration">{{ formatDuration(song.duration) }}</span>
              <span *ngIf="!song.duration" class="empty-cell">—</span>
            </td>

            <td class="col-actions">
              <button
                class="btn btn-ghost btn-xs tooltip"
                [class.text-primary]="song.joinWithNext"
                data-tip="Unir con siguiente"
                (click)="toggleJoinWithNext(song)">
                <ng-icon name="heroArrowTurnDownRight" class="w-4 h-4"></ng-icon>
              </button>
              <button class="btn btn-ghost btn-xs tooltip" data-tip="Editar" (click)="openEditForm(song)">
                <ng-icon name="heroPencil" class="w-4 h-4"></ng-icon>
              </button>
              <button class="btn btn-ghost btn-xs text-error tooltip" data-tip="Eliminar" (click)="deleteSong(song)">
                <ng-icon name="heroTrash" class="w-4 h-4"></ng-icon>
              </button>
            </td>

          </ng-container>

          <!-- Drag placeholder -->
          <div *cdkDragPlaceholder class="drag-placeholder-row"></div>
        </tr>
      </tbody>
    </table>

    <!-- Notes section -->
    <div class="notes-section" *ngIf="hasSongNotes()">
      <div class="notes-title">
        <ng-icon name="heroChatBubbleBottomCenterText" class="w-4 h-4"></ng-icon> Notas
      </div>
      <div class="note-row" *ngFor="let song of songs">
        <ng-container *ngIf="song.type !== 'event' && song.notes">
          <span class="note-num">{{ song.position + 1 }}.</span>
          <span class="note-text">{{ song.notes }}</span>
        </ng-container>
      </div>
    </div>
  </div>

</div>
